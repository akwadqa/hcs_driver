stages:
  - build
  - release

build_android_apk:
  stage: build
  image: ghcr.io/cirruslabs/flutter:stable
  before_script:
    - flutter pub get
    - flutter packages pub run build_runner build --delete-conflicting-outputs
  script:
    - flutter build apk --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
    expire_in: 1 week
  only:
    - main
    - tags

release_apk:
  stage: release
  image: curlimages/curl:latest
  script:
    - echo "Release for $CI_COMMIT_TAG"
  release:
    name: "Release $CI_COMMIT_TAG"
    tag_name: "$CI_COMMIT_TAG"
    description: "Auto-generated APK release for $CI_COMMIT_TAG"
    assets:
      links:
        - name: "Download APK"
          url: "$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/build/app/outputs/flutter-apk/app-release.apk"
  only:
    - tags
